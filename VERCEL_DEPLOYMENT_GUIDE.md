# Vercel Deployment Guide for Squire Monorepo

## ğŸ¯ Overview
This guide covers the Vercel deployment configuration for the Squire monorepo, specifically for the Next.js web application.

## âœ… Fixed Issues
1. **routes-manifest.json Error**: Resolved by removing conflicting configurations
2. **Functions Pattern Error**: Removed unnecessary functions configuration
3. **Monorepo Build**: Configured Turbo for proper monorepo builds
4. **Next.js Config**: Fixed duplicate configuration files

## ğŸ”§ Configuration Files

### `vercel.json`
```json
{
  "version": 2,
  "installCommand": "npm install",
  "buildCommand": "npx turbo run build --filter=web",
  "outputDirectory": "apps/web/.next",
  "env": {
    "NODE_VERSION": "18.x",
    "TURBO_TELEMETRY_DISABLED": "1"
  },
  "headers": [...],
  "rewrites": [...]
}
```

### Key Configuration Points:
- âœ… **No framework detection**: Removed `"framework": "nextjs"` to avoid conflicts
- âœ… **Turbo build**: Uses `npx turbo run build --filter=web` for monorepo
- âœ… **Correct output**: Points to `apps/web/.next` directory
- âœ… **Environment**: Sets Node.js 18.x and disables Turbo telemetry

## ğŸš€ Deployment Process

### 1. Pre-deployment Testing
```bash
# Test build locally
./test-build.sh

# Test Vercel configuration (optional)
./vercel-test.sh
```

### 2. Environment Variables (Required)
Set these in Vercel dashboard:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `NODE_VERSION=18.x`

### 3. Deploy to Vercel
```bash
# Using Vercel CLI
npx vercel

# Or push to GitHub (auto-deploy)
git push origin main
```

## ğŸ” Troubleshooting

### Common Issues & Solutions

#### "routes-manifest.json couldn't be found"
- **Cause**: Conflicting build configuration
- **Solution**: Ensure no `output: 'standalone'` in `next.config.js`

#### "Pattern doesn't match any Serverless Functions"
- **Cause**: Incorrect functions pattern in `vercel.json`
- **Solution**: Remove functions configuration (not needed for most cases)

#### "Build failed"
- **Cause**: Turbo not finding workspace
- **Solution**: Use `npx turbo run build --filter=web` command

### Build Verification
The successful build should include:
```
âœ… routes-manifest.json
âœ… app-build-manifest.json
âœ… build-manifest.json
âœ… next-server.js.nft.json
```

## ğŸ“ File Structure
```
squire/
â”œâ”€â”€ apps/web/               # Next.js application
â”‚   â”œâ”€â”€ .next/             # Build output (auto-generated)
â”‚   â”œâ”€â”€ src/               # Source code
â”‚   â””â”€â”€ next.config.js     # Next.js configuration
â”œâ”€â”€ turbo.json             # Turbo configuration
â”œâ”€â”€ vercel.json            # Vercel deployment config
â”œâ”€â”€ .vercelignore          # Files to ignore during deployment
â””â”€â”€ package.json           # Root package with build scripts
```

## ğŸ¯ Performance Optimizations

### Build Performance
- Uses Turbo caching for faster builds
- Filters to only build web app: `--filter=web`
- Disables Turbo telemetry for faster CI

### Runtime Performance
- CORS headers configured for API routes
- Health check endpoint: `/health` â†’ `/api/health`
- Static files served efficiently

## ğŸ” Security Configuration

### Headers
- CORS configured for API routes
- Proper content type and authorization headers

### Environment
- Sensitive variables managed through Vercel dashboard
- Build-time environment validation

## ğŸ“Š Monitoring

### Build Monitoring
- Check build logs in Vercel dashboard
- Verify `routes-manifest.json` generation
- Monitor build time (should be ~15-20s)

### Runtime Monitoring
- Health check: `https://yourdomain.com/health`
- API routes: `https://yourdomain.com/api/*`

## ğŸš€ Next Steps

1. **Custom Domain**: Configure in Vercel dashboard
2. **SSL Certificate**: Auto-generated by Vercel
3. **Analytics**: Add Vercel Analytics for performance monitoring
4. **Preview Deployments**: Automatic for PR branches

## ğŸ“ Notes

- The configuration is optimized for Next.js 14 App Router
- Monorepo structure supported through Turbo
- No serverless functions configuration needed (handled automatically)
- Build cache managed by Turbo for efficiency

---

## ğŸ†˜ Support

If deployment issues persist:
1. Check build logs in Vercel dashboard
2. Run local test scripts: `./test-build.sh`
3. Verify environment variables are set
4. Ensure latest commit is pushed to GitHub

**Last Updated**: June 2025
**Configuration Version**: v2.0 (Fixed routes-manifest issue) 